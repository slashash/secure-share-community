{"version":3,"sources":["components/formRepeat.js"],"names":["dmx","Component","initialData","canAdd","items","attributes","type","Array","Number","default","min","max","Infinity","sortable","Boolean","handle","String","animation","methods","add","this","_add","remove","index","_remove","move","oldIndex","newIndex","_mode","moveToStart","_move","moveToEnd","children","length","moveBefore","moveAfter","duplicate","_duplicate","reset","_render","render","node","_template","_templateFromChildren","querySelectorAll","forEach","input","firstBracket","name","indexOf","setAttribute","slice","props","_sortable","Sortable","create","onEnd","event","_refresh","performUpdate","updatedProps","has","option","repeatItems","_clear","i","fromInputs","$nodes","nodeType","push","from","toInputs","fromInput","toInput","tagName","value","checked","multiple","fromOption","selectedOptions","toOption","options","selected","dispatchEvent","Event","data","child","cloneNode","$node","appendChild","$parse","splice","$destroy","set","$index","$formindex","$canRemove","$canMoveToStart","$canMoveBefore","$canMoveAfter","$canMoveToEnd","map","innerHTML","updateDOM","template","document","createDocumentFragment","hasChildNodes","firstChild"],"mappings":"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","file":"dmxFormRepeat.js","sourcesContent":["dmx.Component('form-repeat', {\r\n\r\n  initialData: {\r\n    canAdd: true,\r\n    items: []\r\n  },\r\n\r\n  attributes: {\r\n    \r\n    items: {\r\n      type: [Array, Number],\r\n      default: 0\r\n    },\r\n\r\n    min: {\r\n      type: Number,\r\n      default: 0\r\n    },\r\n\r\n    max: {\r\n      type: Number,\r\n      default: Infinity\r\n    },\r\n\r\n    sortable: {\r\n      type: Boolean,\r\n      default: false\r\n    },\r\n\r\n    handle: {\r\n      type: String,\r\n      default: null\r\n    },\r\n\r\n    animation: {\r\n      type: Number,\r\n      default: 0\r\n    }\r\n\r\n  },\r\n\r\n  methods: {\r\n\r\n    add () {\r\n      this._add();\r\n    },\r\n\r\n    remove (index) {\r\n      this._remove(index);\r\n    },\r\n\r\n    move (oldIndex, newIndex) {\r\n      this._mode(oldIndex, newIndex, true);\r\n    },\r\n\r\n    moveToStart (index) {\r\n      this._move(index, 0, true);\r\n    },\r\n\r\n    moveToEnd (index) {\r\n      this._move(index, this.children.length - 1, true);\r\n    },\r\n\r\n    moveBefore (index) {\r\n      this._move(index, index - 1, true);\r\n    },\r\n\r\n    moveAfter (index) {\r\n      this._move(index, index + 1, true);\r\n    },\r\n\r\n    duplicate (index) {\r\n      this._duplicate(index);\r\n    },\r\n\r\n    reset () {\r\n      this._render();\r\n    }\r\n\r\n  },\r\n\r\n  render (node) {\r\n    this._template = this._templateFromChildren(node);\r\n\r\n    const inputs = this._template.querySelectorAll('input[name], select[name], textarea[name]');\r\n\r\n    inputs.forEach((input) => {\r\n      const firstBracket = input.name.indexOf('[');\r\n\r\n      if (firstBracket > 0) {\r\n        input.setAttribute('dmx-bind:name', this.name + '[{{$formindex}}][' + input.name.slice(0, firstBracket) + ']' + input.name.slice(firstBracket));\r\n      } else {\r\n        input.setAttribute('dmx-bind:name', this.name + '[{{$formindex}}][' + input.name + ']');\r\n      }\r\n    });\r\n\r\n    if (this.props.sortable) {\r\n      this._sortable = Sortable.create(node, {\r\n        handle: this.props.handle,\r\n        onEnd: event => this._move(event.oldIndex, event.newIndex)\r\n      });\r\n    }\r\n\r\n    this._render();\r\n    this._refresh();\r\n  },\r\n\r\n  performUpdate (updatedProps) {\r\n    if (updatedProps.has('items')) {\r\n      this._render();\r\n    }\r\n\r\n    if (updatedProps.has('sortable')) {\r\n      if (this._sortable) {\r\n        this._sortable.option('disabled', !this.props.sortable);\r\n      } else {\r\n        this._sortable = Sortable.create(node, {\r\n          handle: this.props.handle,\r\n          onEnd: event => this._move(event.oldIndex, event.newIndex)\r\n        });\r\n      }\r\n    }\r\n\r\n    if (updatedProps.has('handle')) {\r\n      if (this._sortable) {\r\n        this._sortable.option('handle', this.props.handle);\r\n      }\r\n    }\r\n\r\n    if (updatedProps.has('animation')) {\r\n      if (this._sortable) {\r\n        this._sortable.option('animation', this.props.animation);\r\n      }\r\n    }\r\n\r\n    this._refresh();\r\n  },\r\n\r\n  _render () {\r\n    const items = dmx.repeatItems(typeof this.props.items == 'string' ? Number(this.props.items) : this.props.items);\r\n    \r\n    if (items.length < this.props.min) items.length = this.props.min;\r\n    if (items.length > this.props.max) items.length = this.props.max;\r\n\r\n    this._clear();\r\n\r\n    for (let i = 0; i < items.length; i++) {\r\n      this._add(items[i]);\r\n    }\r\n  },\r\n\r\n  _duplicate (index) {\r\n    this._add();\r\n    \r\n    this._move(this.children.length - 1, index + 1, true);\r\n\r\n    let fromInputs = [];\r\n    this.children[index].$nodes.forEach((node) => {\r\n      if (node.nodeType == 1) {\r\n        fromInputs.push(...Array.from(node.querySelectorAll('input[name], textarea[name], select[name]')));\r\n      }\r\n    });\r\n    \r\n    let toInputs = [];\r\n    this.children[index + 1].$nodes.forEach((node) => {\r\n      if (node.nodeType == 1) {\r\n        toInputs.push(...Array.from(node.querySelectorAll('input[name], textarea[name], select[name]')));\r\n      }\r\n    });\r\n\r\n    // Only do something when the inputs match\r\n    if (fromInputs.length == toInputs.length) {\r\n      for (let i = 0; i < fromInputs.length; i++) {\r\n        const fromInput = fromInputs[i];\r\n        const toInput = toInputs[i];\r\n\r\n        // Inputs do not match???\r\n        if (fromInput.tagName != toInput.tagName) break;\r\n\r\n        if (fromInput.tagName == 'TEXTAREA') {\r\n          // textarea just copy value\r\n          toInput.value = fromInput.value;\r\n        } else if (fromInput.tagName == 'INPUT') {\r\n          if (fromInput.type == 'file' || fromInput.type == 'password') {\r\n            // skip file and password types\r\n            continue;\r\n          }\r\n\r\n          if (fromInput.type == 'checkbox' || fromInput.type == 'radio') {\r\n            // checkbox and radio we have to copy the checked property\r\n            toInput.checked = fromInput.checked;\r\n          } else {\r\n            // any other type input just copy value\r\n            toInput.value = fromInput.value;\r\n          }\r\n        } else if (fromInput.tagName == 'SELECT') {\r\n          if (fromInput.multiple) {\r\n            // for multiple selection we need to loop over the options\r\n            // first loop only the selected options\r\n            for (const fromOption of fromInput.selectedOptions) {\r\n              // second loop on target to find matching value\r\n              for (const toOption of toInput.options) {\r\n                if (fromOption.value == toOption.value) {\r\n                  // set selected when value matches\r\n                  toOption.selected = true;\r\n                }\r\n              }\r\n            }\r\n          } else {\r\n            // for single selection we can simply copy the value\r\n            toInput.value = fromInput.value;\r\n          }\r\n        }\r\n\r\n        // trigger a change event on the target to let App Connect know it changed\r\n        toInput.dispatchEvent(new Event('change'));\r\n      }\r\n    }\r\n  },\r\n\r\n  _add (data = {}) {\r\n    if (this.children.length >= this.props.max) return;\r\n\r\n    const RepeatItem = dmx.Component('repeat-item');\r\n    const child = new RepeatItem(this._template.cloneNode(true), this, data);\r\n\r\n    child.$nodes.forEach((node) => {\r\n      this.$node.appendChild(node);\r\n      child.$parse(node);\r\n    });\r\n\r\n    this.children.push(child);\r\n\r\n    this._refresh();\r\n  },\r\n\r\n  _remove (index) {\r\n    if (this.children.length <= this.props.min) return;\r\n\r\n    this.children.splice(index, 1).forEach((child) => {\r\n      child.$destroy();\r\n    });\r\n\r\n    this._refresh();\r\n  },\r\n\r\n  _refresh () {\r\n    this.children.forEach((child, index) => {\r\n      child.set({\r\n        $index: index,\r\n        $formindex: index,\r\n        $canRemove: this.children.length > this.props.min,\r\n        $canMoveToStart: index > 0,\r\n        $canMoveBefore: index > 0,\r\n        $canMoveAfter: index < this.children.length - 1,\r\n        $canMoveToEnd: index < this.children.length - 1\r\n      });\r\n    });\r\n\r\n    this.set('canAdd', this.children.length < this.props.max);\r\n    this.set('items', this.children.map(child => child.data));\r\n  },\r\n\r\n  _clear () {\r\n    this.children.splice(0).forEach((child) => {\r\n      child.$destroy();\r\n    });\r\n\r\n    this.$node.innerHTML = '';\r\n  },\r\n\r\n  _move (oldIndex, newIndex, updateDOM) {\r\n    if (oldIndex < 0 || oldIndex >= this.children.length) return;\r\n    if (newIndex < 0 || newIndex >= this.children.length) return;\r\n\r\n    this.children.splice(newIndex, 0, this.children.splice(oldIndex, 1)[0]);\r\n\r\n    if (updateDOM) {\r\n      this.$node.innerHTML = '';\r\n      this.children.forEach(child => {\r\n        child.$nodes.forEach((node) => {\r\n          this.$node.appendChild(node);\r\n        });\r\n      })\r\n    }\r\n    \r\n    this._refresh();\r\n  },\r\n\r\n  _templateFromChildren (node) {\r\n    const template = document.createDocumentFragment();\r\n    \r\n    while (node.hasChildNodes()) {\r\n      template.appendChild(node.firstChild);\r\n    }\r\n\r\n    return template;\r\n  }\r\n\r\n});"]}